<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Management</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem; border-radius: 12px; margin-bottom: 2rem; box-shadow: 0 8px 32px rgba(0,0,0,0.1); }
        .header-links { margin-top: 1rem; display: flex; gap: 1rem; flex-wrap: wrap; }
        .header-link { background: rgba(255,255,255,0.2); color: white; padding: 0.5rem 1rem; border-radius: 6px; text-decoration: none; font-size: 0.875rem; transition: background 0.2s; }
        .header-link:hover { background: rgba(255,255,255,0.3); color: white; }
        .api-link { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); }
        .api-link:hover { background: rgba(255,255,255,0.25); }
        
        @media (max-width: 600px) {
            .header-links { flex-direction: column; }
            .header-link { text-align: center; }
        }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border-left: 4px solid; }
        .stat-card.assigned { border-left-color: #10b981; }
        .stat-card.unassigned { border-left-color: #f59e0b; }
        .stat-card.manual { border-left-color: #8b5cf6; }
        .stat-card.reseller { border-left-color: #ef4444; }
        .stat-number { font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem; }
        .stat-label { color: #6b7280; font-size: 0.875rem; }
        .filters { background: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; align-items: end; }
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { margin-bottom: 0.5rem; font-weight: 500; color: #374151; }
        .filter-group select, .filter-group input { padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.875rem; }
        .filter-group select:focus, .filter-group input:focus { outline: none; border-color: #667eea; }
        .devices-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1.5rem; }
        .device-card { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 20px rgba(0,0,0,0.08); transition: transform 0.2s, box-shadow 0.2s; }
        .device-card:hover { transform: translateY(-2px); box-shadow: 0 8px 32px rgba(0,0,0,0.12); }
        .device-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .device-model { font-weight: 600; font-size: 1.1rem; color: #1f2937; }
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 500; text-transform: uppercase; }
        .status-assigned { background: #d1fae5; color: #065f46; }
        .status-unassigned { background: #fef3c7; color: #92400e; }
        .device-info { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem; }
        .info-item { display: flex; flex-direction: column; }
        .info-label { font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem; }
        .info-value { font-size: 0.875rem; color: #374151; font-weight: 500; }
        .device-actions { display: flex; gap: 0.5rem; }
        .btn { padding: 0.5rem 1rem; border-radius: 6px; border: none; font-size: 0.875rem; cursor: pointer; transition: background-color 0.2s; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5a67d8; }
        .btn-secondary { background: #e5e7eb; color: #374151; }
        .btn-secondary:hover { background: #d1d5db; }
        .loading { text-align: center; padding: 3rem; }
        .spinner { border: 4px solid #f3f4f6; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Modal styles */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal { background: white; border-radius: 12px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-header { padding: 2rem 2rem 1rem; border-bottom: 1px solid #e5e7eb; }
        .modal-title { font-size: 1.5rem; font-weight: 600; color: #1f2937; }
        .modal-body { padding: 2rem; }
        .modal-footer { padding: 1rem 2rem 2rem; display: flex; gap: 1rem; justify-content: flex-end; }
        .detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .detail-item { background: #f9fafb; padding: 1rem; border-radius: 8px; }
        .detail-label { font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem; }
        .detail-value { font-weight: 500; color: #1f2937; }
        
        /* Advanced filters */
        .advanced-filters { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb; }
        .filter-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
        .btn-filter { background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; }
        .btn-filter.active { background: #667eea; color: white; border-color: #667eea; }
        
        /* Management actions */
        .management-section { background: #f9fafb; padding: 1.5rem; border-radius: 8px; margin-top: 1rem; }
        .action-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .action-item { background: white; padding: 1rem; border-radius: 6px; border: 1px solid #e5e7eb; }
        .action-title { font-weight: 500; margin-bottom: 0.5rem; }
        .action-desc { font-size: 0.875rem; color: #6b7280; margin-bottom: 1rem; }
        
        /* Status indicators */
        .status-indicator { display: inline-flex; align-items: center; gap: 0.5rem; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; }
        .status-dot.assigned { background: #10b981; }
        .status-dot.unassigned { background: #f59e0b; }
        
        /* MDM Servers section */
        .mdm-servers-section { background: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .mdm-servers-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; margin-top: 1rem; }
        .mdm-server-card { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; }
        .mdm-server-name { font-weight: 600; margin-bottom: 0.5rem; color: #1f2937; }
        .mdm-server-info { font-size: 0.875rem; color: #6b7280; }
        .mdm-toggle { background: none; border: none; color: #667eea; cursor: pointer; font-size: 0.875rem; margin-top: 0.5rem; }
        .mdm-toggle:hover { text-decoration: underline; }
        
        /* MDM Server Detail View */
        .mdm-detail-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .mdm-detail-content { background: white; border-radius: 12px; max-width: 1200px; width: 95%; max-height: 90vh; overflow-y: auto; }
        .mdm-detail-header { padding: 2rem; border-bottom: 1px solid #e5e7eb; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; }
        .mdm-detail-body { padding: 2rem; }
        .device-sections { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 1rem; }
        .device-section { background: #f9fafb; border-radius: 12px; padding: 1.5rem; }
        .device-section h4 { margin: 0 0 1rem 0; color: #1f2937; }
        .device-list { max-height: 400px; overflow-y: auto; }
        .device-item { background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center; }
        .device-item:hover { background: #f3f4f6; }
        .device-item.selected { border-color: #6366f1; background: #ede9fe; }
        .device-item-info { flex: 1; }
        .device-item-name { font-weight: 500; margin-bottom: 0.25rem; }
        .device-item-serial { font-size: 0.875rem; color: #6b7280; }
        .device-checkbox { margin-right: 1rem; }
        .bulk-actions { background: white; padding: 1rem; border-radius: 8px; margin-top: 1rem; display: flex; gap: 1rem; align-items: center; }
        .assign-btn { background: #10b981; color: white; }
        .assign-btn:hover { background: #059669; }
        .selected-count { color: #6b7280; margin-left: auto; }
        .back-btn { background: #6b7280; color: white; }
        .back-btn:hover { background: #4b5563; }
        
        /* Device search in MDM detail */
        .device-search { margin-bottom: 1rem; }
        .device-search input { width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.875rem; }
        .device-search input:focus { outline: none; border-color: #6366f1; }
        .device-search-results { font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem; }
        
        @media (max-width: 900px) {
            .device-sections { grid-template-columns: 1fr; }
            .mdm-detail-content { width: 98%; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function DeviceManagement() {
            const [devices, setDevices] = useState([]);
            const [filteredDevices, setFilteredDevices] = useState([]);
            const [loading, setLoading] = useState(true);
            const [customerInfo, setCustomerInfo] = useState(null);
            const [selectedDevice, setSelectedDevice] = useState(null);
            const [showModal, setShowModal] = useState(false);
            const [mdmServers, setMdmServers] = useState([]);
            const [filters, setFilters] = useState({
                status: 'all',
                model: 'all',
                search: '',
                purchaseSource: 'all',
                color: 'all'
            });
            const [advancedFilters, setAdvancedFilters] = useState({
                showAdvanced: false
            });
            const [showMdmServers, setShowMdmServers] = useState(false);
            const [selectedMdmServer, setSelectedMdmServer] = useState(null);
            const [showMdmDetail, setShowMdmDetail] = useState(false);
            const [selectedDevices, setSelectedDevices] = useState(new Set());
            const [assignedToServer, setAssignedToServer] = useState([]);
            const [unassignedDevices, setUnassignedDevices] = useState([]);
            const [unassignedDeviceSearch, setUnassignedDeviceSearch] = useState('');
            const [assignedDeviceSearch, setAssignedDeviceSearch] = useState('');
            const [filteredAssignedDevices, setFilteredAssignedDevices] = useState([]);
            const [filteredUnassignedDevices, setFilteredUnassignedDevices] = useState([]);

            const customerId = new URLSearchParams(window.location.search).get('customer');

            const fetchCustomerInfo = async () => {
                try {
                    const response = await fetch(`/api/customers/${customerId}`);
                    const data = await response.json();
                    setCustomerInfo(data);
                } catch (error) {
                    console.error('Error fetching customer info:', error);
                }
            };

            const fetchDevices = async () => {
                try {
                    setLoading(true);
                    const response = await fetch(`/api/${customerId}/devices`);
                    const data = await response.json();
                    setDevices(data.data || []);
                } catch (error) {
                    console.error('Error fetching devices:', error);
                } finally {
                    setLoading(false);
                }
            };

            const fetchMdmServers = async () => {
                try {
                    const response = await fetch(`/api/${customerId}/mdmServers`);
                    const data = await response.json();
                    setMdmServers(data.data || []);
                } catch (error) {
                    console.error('Error fetching MDM servers:', error);
                }
            };

            useEffect(() => {
                if (customerId) {
                    fetchDevices();
                    fetchCustomerInfo();
                    fetchMdmServers();
                }
            }, [customerId]);

            useEffect(() => {
                applyFilters();
            }, [devices, filters]);

            useEffect(() => {
                // Filter assigned devices based on search
                if (assignedDeviceSearch) {
                    const filtered = assignedToServer.filter(device =>
                        device.attributes?.serialNumber?.toLowerCase().includes(assignedDeviceSearch.toLowerCase()) ||
                        device.attributes?.deviceModel?.toLowerCase().includes(assignedDeviceSearch.toLowerCase()) ||
                        device.id?.toLowerCase().includes(assignedDeviceSearch.toLowerCase())
                    );
                    setFilteredAssignedDevices(filtered);
                } else {
                    setFilteredAssignedDevices(assignedToServer);
                }
            }, [assignedToServer, assignedDeviceSearch]);

            useEffect(() => {
                // Filter unassigned devices based on search
                if (unassignedDeviceSearch) {
                    const filtered = unassignedDevices.filter(device =>
                        device.attributes?.serialNumber?.toLowerCase().includes(unassignedDeviceSearch.toLowerCase()) ||
                        device.attributes?.deviceModel?.toLowerCase().includes(unassignedDeviceSearch.toLowerCase()) ||
                        device.id?.toLowerCase().includes(unassignedDeviceSearch.toLowerCase())
                    );
                    setFilteredUnassignedDevices(filtered);
                } else {
                    setFilteredUnassignedDevices(unassignedDevices);
                }
            }, [unassignedDevices, unassignedDeviceSearch]);

            const applyFilters = () => {
                let filtered = devices;

                if (filters.status !== 'all') {
                    filtered = filtered.filter(device => 
                        device.attributes?.status?.toLowerCase() === filters.status.toLowerCase()
                    );
                }

                if (filters.model !== 'all') {
                    filtered = filtered.filter(device => 
                        device.attributes?.deviceModel?.includes(filters.model)
                    );
                }

                if (filters.purchaseSource !== 'all') {
                    filtered = filtered.filter(device => 
                        device.attributes?.purchaseSourceType === filters.purchaseSource
                    );
                }

                if (filters.color !== 'all') {
                    filtered = filtered.filter(device => 
                        device.attributes?.color?.toLowerCase() === filters.color.toLowerCase()
                    );
                }

                if (filters.search) {
                    filtered = filtered.filter(device => 
                        device.attributes?.serialNumber?.toLowerCase().includes(filters.search.toLowerCase()) ||
                        device.attributes?.deviceModel?.toLowerCase().includes(filters.search.toLowerCase()) ||
                        device.id?.toLowerCase().includes(filters.search.toLowerCase())
                    );
                }

                setFilteredDevices(filtered);
            };

            const getStats = () => {
                const assigned = devices.filter(d => d.attributes?.status === 'ASSIGNED').length;
                const unassigned = devices.filter(d => d.attributes?.status === 'UNASSIGNED').length;
                const manual = devices.filter(d => d.attributes?.purchaseSourceType === 'MANUALLY_ADDED').length;
                const reseller = devices.filter(d => d.attributes?.purchaseSourceType === 'RESELLER').length;

                return { assigned, unassigned, manual, reseller, total: devices.length };
            };

            const getUniqueValues = (field) => {
                const values = new Set();
                devices.forEach(device => {
                    const value = field === 'model' ? device.attributes?.deviceModel : device.attributes?.[field];
                    if (value) {
                        values.add(value);
                    }
                });
                return Array.from(values).sort();
            };

            const handleFilterChange = (filterType, value) => {
                setFilters(prev => ({
                    ...prev,
                    [filterType]: value
                }));
            };

            const viewDeviceDetails = async (deviceId) => {
                try {
                    const response = await fetch(`/api/${customerId}/devices/${deviceId}`);
                    const device = await response.json();
                    
                    // If device is assigned, also fetch the assigned server info
                    if (device.data?.attributes?.status === 'ASSIGNED') {
                        try {
                            const serverResponse = await fetch(`/api/${customerId}/devices/${deviceId}/assignedServer`);
                            const serverData = await serverResponse.json();
                            device.assignedServer = serverData;
                        } catch (error) {
                            console.warn('Could not fetch assigned server info:', error);
                        }
                    }
                    
                    setSelectedDevice(device);
                    setShowModal(true);
                } catch (error) {
                    alert('Error fetching device details');
                }
            };

            const getAssignedServerName = (device) => {
                // This function is now simplified. It will only show a generic status on the main card.
                // The detailed server name will be fetched and shown in the modal.
                if (device.attributes?.status === 'ASSIGNED') {
                    const assignedServerId = device.relationships?.assignedServer?.data?.id;
                    if (assignedServerId) {
                        // We can show the ID if we want, or just "Assigned"
                        return `Assigned (ID: ...${assignedServerId.slice(-6)})`;
                    }
                    return 'Assigned';
                }
                return 'N/A';
            };

            const assignDeviceToMDM = async (deviceId, mdmServerId) => {
                if (!mdmServerId) {
                    alert("Please select an MDM server.");
                    return;
                }
                try {
                    const payload = {
                        data: {
                            type: "orgDeviceActivities",
                            attributes: {
                                activityType: "ASSIGN_DEVICES"
                            },
                            relationships: {
                                mdmServer: {
                                    data: {
                                        type: "mdmServers",
                                        id: mdmServerId
                                    }
                                },
                                devices: {
                                    data: [{
                                        type: "orgDevices",
                                        id: deviceId
                                    }]
                                }
                            }
                        }
                    };

                    const response = await fetch(`/api/${customerId}/orgDeviceActivities`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        alert('Device assigned successfully!');
                        fetchDevices(); // Refresh device list
                        setShowModal(false);
                    } else {
                        alert('Error assigning device');
                    }
                } catch (error) {
                    alert('Error assigning device: ' + error.message);
                }
            };

            const unassignDevice = async (deviceId) => {
                if (!window.confirm('Are you sure you want to unassign this device?')) return;
                try {
                    const response = await fetch(`/api/${customerId}/orgDeviceActivities/unassign`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ device_ids: [deviceId] })
                    });
                    if (response.ok) {
                        alert('Device unassigned successfully!');
                        fetchDevices();
                        setShowModal(false); // Close modal after unassigning
                    } else {
                        alert('Failed to unassign device');
                    }
                } catch (err) {
                    alert('Error unassigning device: ' + err);
                }
            };

            const quickFilter = (filterType) => {
                const newFilters = { ...filters };
                
                switch(filterType) {
                    case 'unassigned':
                        newFilters.status = 'unassigned';
                        break;
                    case 'assigned':
                        newFilters.status = 'assigned';
                        break;
                    case 'manual':
                        newFilters.purchaseSource = 'MANUALLY_ADDED';
                        break;
                    case 'reseller':
                        newFilters.purchaseSource = 'RESELLER';
                        break;
                    case 'reset':
                        newFilters.status = 'all';
                        newFilters.model = 'all';
                        newFilters.purchaseSource = 'all';
                        newFilters.color = 'all';
                        newFilters.search = '';
                        break;
                }
                
                setFilters(newFilters);
            };

            const showMdmServerDetail = async (server) => {
                setSelectedMdmServer(server);
                
                // Get assigned devices for this server using the server mapping
                const assigned = devices.filter(device => {
                    const serverInfo = deviceServerMap.get(device.id);
                    return serverInfo && serverInfo.id === server.id;
                });
                
                // Get unassigned devices
                const unassigned = devices.filter(device => 
                    device.attributes?.status === 'UNASSIGNED'
                );
                
                setAssignedToServer(assigned);
                setUnassignedDevices(unassigned);
                setSelectedDevices(new Set());
                setAssignedDeviceSearch('');
                setUnassignedDeviceSearch('');
                setShowMdmDetail(true);
            };

            const toggleDeviceSelection = (deviceId) => {
                const newSelected = new Set(selectedDevices);
                if (newSelected.has(deviceId)) {
                    newSelected.delete(deviceId);
                } else {
                    newSelected.add(deviceId);
                }
                setSelectedDevices(newSelected);
            };

            const selectAllFilteredUnassigned = () => {
                const allFilteredSelected = filteredUnassignedDevices.length > 0 && filteredUnassignedDevices.every(d => selectedDevices.has(d.id));
                const newSelected = new Set(selectedDevices);

                if (allFilteredSelected) {
                    // Deselect all filtered
                    filteredUnassignedDevices.forEach(d => newSelected.delete(d.id));
                } else {
                    // Select all filtered
                    filteredUnassignedDevices.forEach(d => newSelected.add(d.id));
                }
                setSelectedDevices(newSelected);
            };

            const assignSelectedDevices = async () => {
                if (selectedDevices.size === 0) {
                    alert('Please select devices to assign');
                    return;
                }

                try {
                    const payload = {
                        data: {
                            type: "orgDeviceActivities",
                            attributes: {
                                activityType: "ASSIGN_DEVICES"
                            },
                            relationships: {
                                mdmServer: {
                                    data: {
                                        type: "mdmServers",
                                        id: selectedMdmServer.id
                                    }
                                },
                                devices: {
                                    data: Array.from(selectedDevices).map(deviceId => ({
                                        type: "orgDevices",
                                        id: deviceId
                                    }))
                                }
                            }
                        }
                    };

                    const response = await fetch(`/api/${customerId}/orgDeviceActivities`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        alert(`Successfully assigned ${selectedDevices.size} devices!`);
                        setShowMdmDetail(false);
                        await fetchDevices(); // Refresh device list
                    } else {
                        alert('Error assigning devices');
                    }
                } catch (error) {
                    alert('Error assigning devices: ' + error.message);
                }
            };

            if (!customerId) {
                return (
                    <div className="container">
                        <div className="header">
                            <h1>Error: No customer specified</h1>
                            <p>Please provide a customer ID in the URL parameters.</p>
                        </div>
                    </div>
                );
            }

            if (loading) {
                return (
                    <div className="container">
                        <div className="loading">
                            <div className="spinner"></div>
                            <p>Loading devices...</p>
                        </div>
                    </div>
                );
            }

            const stats = getStats();
            const uniqueModels = getUniqueValues('model');
            const uniqueColors = getUniqueValues('color');

            return (
                <div className="container">
                    <div className="header">
                        <h1>Device Management</h1>
                        <p>
                            {customerInfo ? `${customerInfo.name} - ${customerInfo.manager_type === 'business' ? 'Apple Business Manager' : 'Apple School Manager'}` : 'Loading customer info...'}
                        </p>
                        <p>Total Devices: {stats.total}</p>
                        
                        <div className="header-links">
                            <a href={`/swagger/${customerId}`} target="_blank" className="header-link api-link">
                                📋 Customer API Documentation
                            </a>
                            <a href="/docs" target="_blank" className="header-link api-link">
                                🔧 Full API Documentation
                            </a>
                            <a href="/frontend/" className="header-link">
                                🏠 Back to Admin Panel
                            </a>
                            <a href={`/api/${customerId}/devices`} target="_blank" className="header-link api-link">
                                📱 Raw Devices JSON
                            </a>
                            <a href={`/api/${customerId}/mdmServers`} target="_blank" className="header-link api-link">
                                🖥️ Raw MDM Servers JSON
                            </a>
                        </div>
                    </div>

                    <div className="stats-grid">
                        <div className="stat-card assigned" onClick={() => quickFilter('assigned')} style={{cursor: 'pointer'}}>
                            <div className="stat-number" style={{color: '#10b981'}}>{stats.assigned}</div>
                            <div className="stat-label">Assigned Devices</div>
                        </div>
                        <div className="stat-card unassigned" onClick={() => quickFilter('unassigned')} style={{cursor: 'pointer'}}>
                            <div className="stat-number" style={{color: '#f59e0b'}}>{stats.unassigned}</div>
                            <div className="stat-label">Unassigned Devices</div>
                        </div>
                        <div className="stat-card manual" onClick={() => quickFilter('manual')} style={{cursor: 'pointer'}}>
                            <div className="stat-number" style={{color: '#8b5cf6'}}>{stats.manual}</div>
                            <div className="stat-label">Manually Added</div>
                        </div>
                        <div className="stat-card reseller" onClick={() => quickFilter('reseller')} style={{cursor: 'pointer'}}>
                            <div className="stat-number" style={{color: '#ef4444'}}>{stats.reseller}</div>
                            <div className="stat-label">From Reseller</div>
                        </div>
                        <div className="stat-card" style={{borderLeftColor: '#6366f1', cursor: 'pointer'}} onClick={() => setShowMdmServers(!showMdmServers)}>
                            <div className="stat-number" style={{color: '#6366f1'}}>{mdmServers.length}</div>
                            <div className="stat-label">MDM Servers</div>
                        </div>
                    </div>

                    {showMdmServers && (
                        <div className="mdm-servers-section">
                            <h3 style={{margin: '0 0 1rem 0', color: '#1f2937'}}>Available MDM Servers</h3>
                            {mdmServers.length > 0 ? (
                                <div className="mdm-servers-grid">
                                    {mdmServers.map(server => (
                                        <div key={server.id} className="mdm-server-card">
                                            <div className="mdm-server-name">
                                                {server.attributes?.serverName || server.attributes?.name || server.id}
                                            </div>
                                            <div className="mdm-server-info">
                                                <div><strong>Organization:</strong> {server.attributes?.organizationName || 'N/A'}</div>
                                                <div><strong>Server ID:</strong> {server.id}</div>
                                                {server.attributes?.serverUrl && (
                                                    <div><strong>URL:</strong> {server.attributes.serverUrl}</div>
                                                )}
                                            </div>
                                            <button 
                                                className="mdm-toggle"
                                                onClick={() => showMdmServerDetail(server)}
                                            >
                                                View Device Assignments
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <p style={{color: '#6b7280', textAlign: 'center', margin: '2rem 0'}}>
                                    No MDM servers configured for this customer.
                                </p>
                            )}
                            <button 
                                className="btn btn-secondary" 
                                onClick={() => setShowMdmServers(false)}
                                style={{marginTop: '1rem'}}
                            >
                                Hide MDM Servers
                            </button>
                        </div>
                    )}

                    <div className="filters">
                        <div className="filter-row">
                            <button className="btn btn-filter" onClick={() => quickFilter('reset')}>Show All</button>
                            <button className={`btn btn-filter ${filters.status === 'unassigned' ? 'active' : ''}`} 
                                    onClick={() => quickFilter('unassigned')}>Unassigned Only</button>
                            <button className={`btn btn-filter ${filters.status === 'assigned' ? 'active' : ''}`} 
                                    onClick={() => quickFilter('assigned')}>Assigned Only</button>
                            <button className="btn btn-filter" 
                                    onClick={() => setAdvancedFilters(prev => ({...prev, showAdvanced: !prev.showAdvanced}))}>
                                {advancedFilters.showAdvanced ? 'Hide' : 'Show'} Advanced Filters
                            </button>
                        </div>

                        <div className="filter-grid">
                            <div className="filter-group">
                                <label>Search</label>
                                <input 
                                    type="text" 
                                    placeholder="Serial, model, or device ID..."
                                    value={filters.search}
                                    onChange={(e) => handleFilterChange('search', e.target.value)}
                                />
                            </div>
                            <div className="filter-group">
                                <label>Status</label>
                                <select 
                                    value={filters.status} 
                                    onChange={(e) => handleFilterChange('status', e.target.value)}
                                >
                                    <option value="all">All Status</option>
                                    <option value="assigned">Assigned</option>
                                    <option value="unassigned">Unassigned</option>
                                </select>
                            </div>
                        </div>

                        {advancedFilters.showAdvanced && (
                            <div className="advanced-filters">
                                <div className="filter-grid">
                                    <div className="filter-group">
                                        <label>Model</label>
                                        <select 
                                            value={filters.model} 
                                            onChange={(e) => handleFilterChange('model', e.target.value)}
                                        >
                                            <option value="all">All Models</option>
                                            {uniqueModels.map(model => (
                                                <option key={model} value={model}>{model}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div className="filter-group">
                                        <label>Purchase Source</label>
                                        <select 
                                            value={filters.purchaseSource} 
                                            onChange={(e) => handleFilterChange('purchaseSource', e.target.value)}
                                        >
                                            <option value="all">All Sources</option>
                                            <option value="MANUALLY_ADDED">Manually Added</option>
                                            <option value="RESELLER">Reseller</option>
                                        </select>
                                    </div>
                                    <div className="filter-group">
                                        <label>Color</label>
                                        <select 
                                            value={filters.color} 
                                            onChange={(e) => handleFilterChange('color', e.target.value)}
                                        >
                                            <option value="all">All Colors</option>
                                            {uniqueColors.map(color => (
                                                <option key={color} value={color}>{color}</option>
                                            ))}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>

                    <div className="devices-grid">
                        {filteredDevices.map(device => (
                            <div key={device.id} className="device-card">
                                <div className="device-header">
                                    <div className="device-model">
                                        {device.attributes?.deviceModel || 'Unknown Model'}
                                    </div>
                                    <div className="status-indicator">
                                        <div className={`status-dot ${device.attributes?.status?.toLowerCase()}`}></div>
                                        <span className={`status-badge status-${device.attributes?.status?.toLowerCase()}`}>
                                            {device.attributes?.status || 'Unknown'}
                                        </span>
                                    </div>
                                </div>
                                
                                <div className="device-info">
                                    <div className="info-item">
                                        <div className="info-label">Serial Number</div>
                                        <div className="info-value">{device.attributes?.serialNumber || 'N/A'}</div>
                                    </div>
                                    <div className="info-item">
                                        <div className="info-label">Device ID</div>
                                        <div className="info-value">{device.id.substring(0, 12)}...</div>
                                    </div>
                                    <div className="info-item">
                                        <div className="info-label">Purchase Source</div>
                                        <div className="info-value">{device.attributes?.purchaseSourceType || 'N/A'}</div>
                                    </div>
                                    <div className="info-item">
                                        <div className="info-label">
                                            {device.attributes?.status === 'ASSIGNED' ? 'Assignment' : 'Color'}
                                        </div>
                                        <div className="info-value">
                                            {device.attributes?.status === 'ASSIGNED' 
                                                ? 'Assigned'
                                                : (device.attributes?.color || 'N/A')
                                            }
                                        </div>
                                    </div>
                                </div>

                                <div className="device-actions">
                                    <button 
                                        className="btn btn-primary"
                                        onClick={() => viewDeviceDetails(device.id)}
                                    >
                                        View Details
                                    </button>
                                    {/* The assign/unassign buttons are now inside the modal */}
                                </div>
                            </div>
                        ))}
                    </div>

                    {filteredDevices.length === 0 && (
                        <div style={{textAlign: 'center', padding: '3rem', color: '#6b7280'}}>
                            <p>No devices found matching your filters.</p>
                            <button className="btn btn-secondary" onClick={() => quickFilter('reset')} style={{marginTop: '1rem'}}>
                                Clear All Filters
                            </button>
                        </div>
                    )}

                    {/* Device Details/Management Modal */}
                    {showModal && selectedDevice && (
                        <div className="modal-overlay" onClick={() => setShowModal(false)}>
                            <div className="modal" onClick={(e) => e.stopPropagation()}>
                                <div className="modal-header">
                                    <h2 className="modal-title">
                                        {selectedDevice.data ? 'Device Details & Management' : 'Assign Device'}
                                    </h2>
                                </div>
                                <div className="modal-body">
                                    {selectedDevice.data ? (
                                        // Detailed view for any device
                                        <DeviceDetailView 
                                            device={selectedDevice} 
                                            mdmServers={mdmServers}
                                            onAssign={assignDeviceToMDM}
                                            onUnassign={unassignDevice}
                                        />
                                    ) : (
                                        // Simplified assignment view for unassigned devices
                                        <AssignDeviceView
                                            device={selectedDevice}
                                            mdmServers={mdmServers}
                                            onAssign={assignDeviceToMDM}
                                        />
                                    )}
                                </div>
                                <div className="modal-footer">
                                    <button className="btn btn-secondary" onClick={() => setShowModal(false)}>
                                        Close
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* MDM Server Detail Modal */}
                    {showMdmDetail && selectedMdmServer && (
                        <div className="mdm-detail-modal" onClick={() => setShowMdmDetail(false)}>
                            <div className="mdm-detail-content" onClick={(e) => e.stopPropagation()}>
                                <div className="mdm-detail-header">
                                    <h2 style={{margin: 0}}>
                                        {selectedMdmServer.attributes?.serverName || selectedMdmServer.attributes?.name || selectedMdmServer.id}
                                    </h2>
                                    <p style={{margin: '0.5rem 0 0 0', opacity: 0.9}}>
                                        {selectedMdmServer.attributes?.organizationName || 'MDM Server Management'}
                                    </p>
                                </div>
                                <div className="mdm-detail-body">
                                    <div className="device-sections">
                                        <div className="device-section">
                                            <h4>
                                                Devices Assigned to this Server ({assignedToServer.length})
                                                <span style={{fontSize: '0.875rem', fontWeight: 'normal', color: '#6b7280', marginLeft: '0.5rem'}}>
                                                    Currently managed by this server
                                                </span>
                                            </h4>
                                            
                                            <div className="device-search">
                                                <input
                                                    type="text"
                                                    placeholder="Search assigned devices by serial number, model, or device ID..."
                                                    value={assignedDeviceSearch}
                                                    onChange={(e) => setAssignedDeviceSearch(e.target.value)}
                                                />
                                                {assignedDeviceSearch && (
                                                    <div className="device-search-results">
                                                        Showing {filteredAssignedDevices.length} of {assignedToServer.length} assigned devices
                                                    </div>
                                                )}
                                            </div>
                                            
                                            <div className="device-list">
                                                {filteredAssignedDevices.length > 0 ? (
                                                    filteredAssignedDevices.map(device => (
                                                        <div key={device.id} className="device-item">
                                                            <div className="device-item-info">
                                                                <div className="device-item-name">
                                                                    {device.attributes?.deviceModel || 'Unknown Model'}
                                                                </div>
                                                                <div className="device-item-serial">
                                                                    Serial: {device.attributes?.serialNumber || 'N/A'}
                                                                </div>
                                                                <div className="device-item-serial">
                                                                    ID: {device.id.substring(0, 16)}...
                                                                </div>
                                                            </div>
                                                            <div className="status-indicator">
                                                                <div className="status-dot assigned"></div>
                                                                <span style={{fontSize: '0.75rem', color: '#10b981'}}>ASSIGNED</span>
                                                            </div>
                                                        </div>
                                                    ))
                                                ) : assignedDeviceSearch ? (
                                                    <p style={{color: '#6b7280', textAlign: 'center', padding: '2rem'}}>
                                                        No assigned devices match your search criteria.
                                                    </p>
                                                ) : (
                                                    <p style={{color: '#6b7280', textAlign: 'center', padding: '2rem'}}>
                                                        No devices currently assigned to this server.
                                                    </p>
                                                )}
                                            </div>
                                        </div>

                                        <div className="device-section">
                                            <h4>
                                                Unassigned Devices ({unassignedDevices.length})
                                                <span style={{fontSize: '0.875rem', fontWeight: 'normal', color: '#6b7280', marginLeft: '0.5rem'}}>
                                                    Available for assignment
                                                </span>
                                            </h4>
                                            
                                            <div className="device-search">
                                                <input
                                                    type="text"
                                                    placeholder="Search unassigned devices by serial number, model, or device ID..."
                                                    value={unassignedDeviceSearch}
                                                    onChange={(e) => setUnassignedDeviceSearch(e.target.value)}
                                                />
                                                {unassignedDeviceSearch && (
                                                    <div className="device-search-results">
                                                        Showing {filteredUnassignedDevices.length} of {unassignedDevices.length} unassigned devices
                                                    </div>
                                                )}
                                            </div>
                                            
                                            <div className="device-list">
                                                {filteredUnassignedDevices.length > 0 ? (
                                                    filteredUnassignedDevices.map(device => (
                                                        <div key={device.id} className={`device-item ${selectedDevices.has(device.id) ? 'selected' : ''}`} onClick={() => toggleDeviceSelection(device.id)}>
                                                            <input 
                                                                type="checkbox" 
                                                                className="device-checkbox"
                                                                checked={selectedDevices.has(device.id)}
                                                                onChange={() => toggleDeviceSelection(device.id)}
                                                                onClick={(e) => e.stopPropagation()}
                                                            />
                                                            <div className="device-item-info">
                                                                <div className="device-item-name">
                                                                    {device.attributes?.deviceModel || 'Unknown Model'}
                                                                </div>
                                                                <div className="device-item-serial">
                                                                    Serial: {device.attributes?.serialNumber || 'N/A'}
                                                                </div>
                                                                <div className="device-item-serial">
                                                                    ID: {device.id.substring(0, 16)}...
                                                                </div>
                                                            </div>
                                                            <div className="status-indicator">
                                                                <div className="status-dot unassigned"></div>
                                                                <span style={{fontSize: '0.75rem', color: '#f59e0b'}}>UNASSIGNED</span>
                                                            </div>
                                                        </div>
                                                    ))
                                                ) : unassignedDeviceSearch ? (
                                                    <p style={{color: '#6b7280', textAlign: 'center', padding: '2rem'}}>
                                                        No unassigned devices match your search criteria.
                                                        <br />
                                                        <button 
                                                            style={{marginTop: '1rem', background: 'none', border: 'none', color: '#667eea', cursor: 'pointer', textDecoration: 'underline'}}
                                                            onClick={() => setUnassignedDeviceSearch('')}
                                                        >
                                                            Clear search
                                                        </button>
                                                    </p>
                                                ) : (
                                                    <p style={{color: '#6b7280', textAlign: 'center', padding: '2rem'}}>
                                                        No unassigned devices available.
                                                    </p>
                                                )}
                                            </div>
                                            
                                            {filteredUnassignedDevices.length > 0 && (
                                                <div className="bulk-actions">
                                                    <button 
                                                        className="btn btn-secondary"
                                                        onClick={selectAllFilteredUnassigned}
                                                    >
                                                        {filteredUnassignedDevices.length > 0 && filteredUnassignedDevices.every(d => selectedDevices.has(d.id))
                                                            ? 'Deselect All Filtered' 
                                                            : 'Select All Filtered'}
                                                    </button>
                                                    <button 
                                                        className="btn assign-btn"
                                                        onClick={assignSelectedDevices}
                                                        disabled={selectedDevices.size === 0}
                                                    >
                                                        Assign Selected ({selectedDevices.size})
                                                    </button>
                                                    <span className="selected-count">
                                                        {selectedDevices.size} selected
                                                        {unassignedDeviceSearch && ` (${filteredUnassignedDevices.length} filtered)`}
                                                    </span>
                                                </div>
                                            )}
                                        </div>
                                    </div>

                                    <div style={{marginTop: '2rem', textAlign: 'center'}}>
                                        <button 
                                            className="btn back-btn"
                                            onClick={() => setShowMdmDetail(false)}
                                        >
                                            Back to Device Overview
                                        </button>
                                    </div>
                                </div>
                            </div>
                        );
                    }
            
                    function DeviceDetailView({ device, mdmServers, onAssign, onUnassign }) {
                        const [selectedMdm, setSelectedMdm] = useState('');
                        const { data, assignedServer } = device;
                        const attributes = data?.attributes || {};
                        const assignedServerInfo = assignedServer?.data?.attributes;
                        const assignedServerId = assignedServer?.data?.id;

                        return (
                            <div>
                                <div className="detail-grid">
                                    <div className="detail-item"><div className="detail-label">Model</div><div className="detail-value">{attributes.deviceModel || 'N/A'}</div></div>
                                    <div className="detail-item"><div className="detail-label">Serial</div><div className="detail-value">{attributes.serialNumber || 'N/A'}</div></div>
                                    <div className="detail-item"><div className="detail-label">Status</div><div className="detail-value">{attributes.status || 'N/A'}</div></div>
                                    <div className="detail-item"><div className="detail-label">Device ID</div><div className="detail-value">{data.id}</div></div>
                                </div>
                                <div className="management-section">
                                    <h3>Device Assignment</h3>
                                    {attributes.status === 'ASSIGNED' ? (
                                        <div>
                                            <p>Currently assigned to:</p>
                                            <div className="detail-item" style={{ background: '#eef2ff', borderColor: '#667eea' }}>
                                                <div className="detail-label">MDM Server</div>
                                                <div className="detail-value">{assignedServerInfo?.serverName || assignedServerInfo?.name || assignedServerId || 'Loading...'}</div>
                                            </div>
                                            <button className="btn btn-secondary" onClick={() => onUnassign(data.id)} style={{marginTop: '1rem', background: '#ef4444', color: 'white'}}>
                                                Unassign Device
                                            </button>
                                        </div>
                                    ) : (
                                        <div className="action-item">
                                            <div className="action-title">Assign to MDM Server</div>
                                            <p>This device is currently unassigned.</p>
                                            <select value={selectedMdm} onChange={e => setSelectedMdm(e.target.value)} style={{width: '100%', padding: '0.5rem', marginBottom: '1rem', marginTop: '0.5rem'}}>
                                                <option value="">Select a server...</option>
                                                {mdmServers.map(server => (
                                                    <option key={server.id} value={server.id}>
                                                        {server.attributes?.serverName || server.attributes?.name || server.id}
                                                    </option>
                                                ))}
                                            </select>
                                            <button 
                                                className="btn btn-primary" 
                                                onClick={() => onAssign(data.id, selectedMdm)}
                                                disabled={!selectedMdm}
                                            >
                                                Assign
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        );
                    }

                    function AssignDeviceView({ device, mdmServers, onAssign }) {
                         const [selectedMdm, setSelectedMdm] = useState('');
                         return (
                            <div>
                                <div className="detail-grid">
                                    <div className="detail-item"><div className="detail-label">Device</div><div className="detail-value">{device.attributes?.deviceModel || 'Unknown Model'}</div></div>
                                    <div className="detail-item"><div className="detail-label">Serial Number</div><div className="detail-value">{device.attributes?.serialNumber || 'N/A'}</div></div>
                                </div>
                                <div className="management-section">
                                    <h3>Assign to MDM Server</h3>
                                    <div className="action-grid">
                                        {mdmServers.map(server => (
                                            <div key={server.id} className="action-item">
                                                <div className="action-title">{server.attributes?.serverName  || server.attributes?.name || server.id}</div>
                                                <div className="action-desc">{server.attributes?.organizationName || 'MDM Server'}</div>
                                                <button className="btn btn-primary" onClick={() => onAssign(device.id, server.id)}>Assign Here</button>
                                            </div>
                                        ))}
                                    </div>
                                    {mdmServers.length === 0 && <p style={{color: '#6b7280', textAlign: 'center'}}>No MDM servers available for assignment.</p>}
                                </div>
                            </div>
                         );
                    }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<DeviceManagement />);
    </script>
</body>
</html>
                                            <div className="device-list">
                                                {filteredUnassignedDevices.length > 0 ? (
                                                    filteredUnassignedDevices.map(device => (
                                                        <div 
                                                            key={device.id} 
                                                            className={`device-item ${selectedDevices.has(device.id) ? 'selected' : ''}`}
                                                            onClick={() => toggleDeviceSelection(device.id)}
                                                            style={{cursor: 'pointer'}}
                                                        >
                                                            <input 
                                                                type="checkbox" 
                                                                className="device-checkbox"
                                                                checked={selectedDevices.has(device.id)}
                                                                onChange={() => toggleDeviceSelection(device.id)}
                                                                onClick={(e) => e.stopPropagation()}
                                                            />
                                                            <div className="device-item-info">
                                                                <div className="device-item-name">
                                                                    {device.attributes?.deviceModel || 'Unknown Model'}
                                                                </div>
                                                                <div className="device-item-serial">
                                                                    Serial: {device.attributes?.serialNumber || 'N/A'}
                                                                </div>
                                                                <div className="device-item-serial">
                                                                    ID: {device.id.substring(0, 16)}...
                                                                </div>
                                                            </div>
                                                            <div className="status-indicator">
                                                                <div className="status-dot unassigned"></div>
                                                                <span style={{fontSize: '0.75rem', color: '#f59e0b'}}>UNASSIGNED</span>
                                                            </div>
                                                        </div>
                                                    ))
                                                ) : unassignedDeviceSearch ? (
                                                    <p style={{color: '#6b7280', textAlign: 'center', padding: '2rem'}}>
                                                        No unassigned devices match your search criteria.
                                                        <br />
                                                        <button 
                                                            style={{marginTop: '1rem', background: 'none', border: 'none', color: '#667eea', cursor: 'pointer', textDecoration: 'underline'}}
                                                            onClick={() => setUnassignedDeviceSearch('')}
                                                        >
                                                            Clear search
                                                        </button>
                                                    </p>
                                                ) : (
                                                    <p style={{color: '#6b7280', textAlign: 'center', padding: '2rem'}}>
                                                        No unassigned devices available.
                                                    </p>
                                                )}
                                            </div>
                                            
                                            {filteredUnassignedDevices.length > 0 && (
                                                <div className="bulk-actions">
                                                    <button 
                                                        className="btn btn-secondary"
                                                        onClick={selectAllFilteredUnassigned}
                                                    >
                                                        {filteredUnassignedDevices.length > 0 && filteredUnassignedDevices.every(d => selectedDevices.has(d.id))
                                                            ? 'Deselect All Filtered' 
                                                            : 'Select All Filtered'}
                                                    </button>
                                                    <button 
                                                        className="btn assign-btn"
                                                        onClick={assignSelectedDevices}
                                                        disabled={selectedDevices.size === 0}
                                                    >
                                                        Assign Selected ({selectedDevices.size})
                                                    </button>
                                                    <span className="selected-count">
                                                        {selectedDevices.size} selected
                                                        {unassignedDeviceSearch && ` (${filteredUnassignedDevices.length} filtered)`}
                                                    </span>
                                                </div>
                                            )}
                                        </div>
                                    </div>

                                    <div style={{marginTop: '2rem', textAlign: 'center'}}>
                                        <button 
                                            className="btn back-btn"
                                            onClick={() => setShowMdmDetail(false)}
                                        >
                                            Back to Device Overview
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<DeviceManagement />);
    </script>
</body>
</html>
                                    </div>
                                </div>
                            </div>
                        );
                    }
            
                    function DevicesGrid({ devices, onViewDetails, getAssignedServerName }) {
                        if (devices.length === 0) {
                            return <p>No devices match the current filters.</p>;
                        }
                        return (
                            <div className="devices-grid">
                                {devices.map(device => (
                                    <DeviceCard 
                                        key={device.id} 
                                        device={device} 
                                        onViewDetails={onViewDetails} 
                                        getAssignedServerName={getAssignedServerName}
                                    />
                                ))}
                            </div>
                        );
                    }
            
                    function DeviceCard({ device, onViewDetails, getAssignedServerName }) {
                        const { id, attributes } = device;
                        const status = attributes?.status || 'UNKNOWN';
                        const assignedServerName = status === 'ASSIGNED' ? getAssignedServerName(device) : 'N/A';
            
                        return (
                            <div className="device-card">
                                <div className="device-header">
                                    <span className="device-model">{attributes?.deviceModel || 'Unknown Model'}</span>
                                    <span className={`status-badge status-${status.toLowerCase()}`}>{status}</span>
                                </div>
                                <div className="device-info">
                                    <InfoItem label="Serial Number" value={attributes?.serialNumber || 'N/A'} />
                                    <InfoItem label="Assigned MDM" value={assignedServerName} />
                                    <InfoItem label="Purchase Source" value={attributes?.purchaseSourceType || 'N/A'} />
                                    <InfoItem label="Color" value={attributes?.color || 'N/A'} />
                                </div>
                                <div className="device-actions">
                                    <button className="btn btn-primary" onClick={() => onViewDetails(id)}>View Details</button>
                                </div>
                            </div>
                        );
                    }
            
                    function InfoItem({ label, value }) {
                        return (
                            <div className="info-item">
                                <div className="info-label">{label}</div>
                                <div className="info-value">{value}</div>
                            </div>
                        );
                    }
            
                    function DeviceDetailModal({ device, onClose, mdmServers, onAssign, onUnassign }) {
                        const [selectedMdm, setSelectedMdm] = useState('');
                        const { data, assignedServer } = device;
                        const attributes = data?.attributes || {};
                        const relationships = data?.relationships || {};
            
                        const assignedServerInfo = assignedServer?.data?.attributes;
                        const assignedServerId = assignedServer?.data?.id;
            
                        return (
                            <div className="modal-overlay" onClick={onClose}>
                                <div className="modal" onClick={e => e.stopPropagation()}>
                                    <div className="modal-header">
                                        <h2 className="modal-title">{attributes.deviceModel || 'Device Details'}</h2>
                                    </div>
                                    <div className="modal-body">
                                        <div className="detail-grid">
                                            <DetailItem label="Serial Number" value={attributes.serialNumber} />
                                            <DetailItem label="Device ID" value={data.id} />
                                            <DetailItem label="Status" value={attributes.status} />
                                            <DetailItem label="Color" value={attributes.color} />
                                            <DetailItem label="Storage" value={attributes.storage} />
                                            <DetailItem label="MEID" value={attributes.meid} />
                                            <DetailItem label="OS" value={attributes.os} />
                                            <DetailItem label="Device Family" value={attributes.deviceFamily} />
                                            <DetailItem label="Purchase Source" value={attributes.purchaseSourceType} />
                                            <DetailItem label="Order Number" value={attributes.orderNumber} />
                                            <DetailItem label="PO Number" value={attributes.poNumber} />
                                            <DetailItem label="Acquisition Date" value={new Date(attributes.acquisitionDate).toLocaleDateString()} />
                                        </div>
                                        
                                        <div className="management-section">
                                            <h3>Management</h3>
                                            {attributes.status === 'ASSIGNED' ? (
                                                <div>
                                                    <p>Currently assigned to:</p>
                                                    <div className="detail-item">
                                                        <div className="detail-label">MDM Server</div>
                                                        <div className="detail-value">{assignedServerInfo?.serverName || assignedServerInfo?.name || assignedServerId || 'Loading...'}</div>
                                                    </div>
                                                    <button className="btn btn-secondary" onClick={() => onUnassign(data.id)} style={{marginTop: '1rem'}}>Unassign Device</button>
                                                </div>
                                            ) : (
                                                <div className="action-grid">
                                                    <div className="action-item">
                                                        <div className="action-title">Assign to MDM Server</div>
                                                        <div className="action-desc">Select an MDM server to assign this device to.</div>
                                                        <select value={selectedMdm} onChange={e => setSelectedMdm(e.target.value)} style={{width: '100%', padding: '0.5rem', marginBottom: '1rem'}}>
                                                            <option value="">Select a server...</option>
                                                            {mdmServers.map(server => (
                                                                <option key={server.id} value={server.id}>
                                                                    {server.attributes?.serverName || server.attributes?.name || server.id}
                                                                </option>
                                                            ))}
                                                        </select>
                                                        <button 
                                                            className="btn btn-primary" 
                                                            onClick={() => onAssign(data.id, selectedMdm)}
                                                            disabled={!selectedMdm}
                                                        >
                                                            Assign
                                                        </button>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                    <div className="modal-footer">
                                        <button className="btn btn-secondary" onClick={onClose}>Close</button>
                                    </div>
                                </div>
                            </div>
                        );
                    }
            
                    function DetailItem({ label, value }) {
                        return (
                            <div className="detail-item">
                                <div className="detail-label">{label}</div>
                                <div className="detail-value">{value || 'N/A'}</div>
                            </div>
                        );
                    }
            
                    function MdmServerDetailView({ 
                        server, onClose, assignedDevices, unassignedDevices, 
                        selectedDevices, onDeviceSelect, onBulkAssign,
                        unassignedDeviceSearch, setUnassignedDeviceSearch,
                        assignedDeviceSearch, setAssignedDeviceSearch
                    }) {
                        return (
                            <div className="mdm-detail-modal">
                                <div className="mdm-detail-content">
                                    <div className="mdm-detail-header">
                                        <h2>{server.attributes?.serverName || server.attributes?.name}</h2>
                                        <p>ID: {server.id}</p>
                                    </div>
                                    <div className="mdm-detail-body">
                                        <div className="device-sections">
                                            <div className="device-section">
                                                <h4>Devices Assigned to this Server ({assignedDevices.length})</h4>
                                                <div className="device-search">
                                                    <input 
                                                        type="text" 
                                                        placeholder="Search assigned devices..." 
                                                        value={assignedDeviceSearch}
                                                        onChange={e => setAssignedDeviceSearch(e.target.value)}
                                                    />
                                                </div>
                                                <div className="device-list">
                                                    {assignedDevices.map(device => (
                                                        <div key={device.id} className="device-item">
                                                            <div className="device-item-info">
                                                                <div className="device-item-name">{device.attributes?.deviceModel}</div>
                                                                <div className="device-item-serial">SN: {device.attributes?.serialNumber}</div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                            <div className="device-section">
                                                <h4>Unassigned Devices ({unassignedDevices.length})</h4>
                                                <div className="device-search">
                                                    <input 
                                                        type="text" 
                                                        placeholder="Search unassigned devices..." 
                                                        value={unassignedDeviceSearch}
                                                        onChange={e => setUnassignedDeviceSearch(e.target.value)}
                                                    />
                                                </div>
                                                <div className="device-list">
                                                    {unassignedDevices.map(device => (
                                                        <div key={device.id} className={`device-item ${selectedDevices.has(device.id) ? 'selected' : ''}`} onClick={() => onDeviceSelect(device.id)}>
                                                            <input 
                                                                type="checkbox" 
                                                                className="device-checkbox"
                                                                checked={selectedDevices.has(device.id)}
                                                                readOnly
                                                            />
                                                            <div className="device-item-info">
                                                                <div className="device-item-name">{device.attributes?.deviceModel}</div>
                                                                <div className="device-item-serial">SN: {device.attributes?.serialNumber}</div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                        <div className="bulk-actions">
                                            <button className="btn assign-btn" onClick={onBulkAssign} disabled={selectedDevices.size === 0}>
                                                Assign Selected ({selectedDevices.size}) to this Server
                                            </button>
                                            <span className="selected-count">{selectedDevices.size} devices selected</span>
                                        </div>
                                    </div>
                                    <div className="modal-footer">
                                        <button className="btn back-btn" onClick={onClose}>Back to Device List</button>
                                    </div>
                                </div>
                            </div>
                        );
                    }
            
                    const root = ReactDOM.createRoot(document.getElementById('root'));
                    root.render(<DeviceManagement />);
                </script>
            </body>
            </html>

