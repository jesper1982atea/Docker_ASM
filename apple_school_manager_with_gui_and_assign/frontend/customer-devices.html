<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Management</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem; border-radius: 12px; margin-bottom: 2rem; box-shadow: 0 8px 32px rgba(0,0,0,0.1); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border-left: 4px solid; }
        .stat-card.assigned { border-left-color: #10b981; }
        .stat-card.unassigned { border-left-color: #f59e0b; }
        .stat-card.manual { border-left-color: #8b5cf6; }
        .stat-card.reseller { border-left-color: #ef4444; }
        .stat-number { font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem; }
        .stat-label { color: #6b7280; font-size: 0.875rem; }
        .filters { background: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; align-items: end; }
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { margin-bottom: 0.5rem; font-weight: 500; color: #374151; }
        .filter-group select, .filter-group input { padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.875rem; }
        .filter-group select:focus, .filter-group input:focus { outline: none; border-color: #667eea; }
        .devices-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1.5rem; }
        .device-card { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 20px rgba(0,0,0,0.08); transition: transform 0.2s, box-shadow 0.2s; }
        .device-card:hover { transform: translateY(-2px); box-shadow: 0 8px 32px rgba(0,0,0,0.12); }
        .device-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .device-model { font-weight: 600; font-size: 1.1rem; color: #1f2937; }
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 500; text-transform: uppercase; }
        .status-assigned { background: #d1fae5; color: #065f46; }
        .status-unassigned { background: #fef3c7; color: #92400e; }
        .device-info { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem; }
        .info-item { display: flex; flex-direction: column; }
        .info-label { font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem; }
        .info-value { font-size: 0.875rem; color: #374151; font-weight: 500; }
        .device-actions { display: flex; gap: 0.5rem; }
        .btn { padding: 0.5rem 1rem; border-radius: 6px; border: none; font-size: 0.875rem; cursor: pointer; transition: background-color 0.2s; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5a67d8; }
        .btn-secondary { background: #e5e7eb; color: #374151; }
        .btn-secondary:hover { background: #d1d5db; }
        .loading { text-align: center; padding: 3rem; }
        .spinner { border: 4px solid #f3f4f6; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Modal styles */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal { background: white; border-radius: 12px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-header { padding: 2rem 2rem 1rem; border-bottom: 1px solid #e5e7eb; }
        .modal-title { font-size: 1.5rem; font-weight: 600; color: #1f2937; }
        .modal-body { padding: 2rem; }
        .modal-footer { padding: 1rem 2rem 2rem; display: flex; gap: 1rem; justify-content: flex-end; }
        .detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .detail-item { background: #f9fafb; padding: 1rem; border-radius: 8px; }
        .detail-label { font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem; }
        .detail-value { font-weight: 500; color: #1f2937; }
        
        /* Advanced filters */
        .advanced-filters { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb; }
        .filter-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
        .btn-filter { background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; }
        .btn-filter.active { background: #667eea; color: white; border-color: #667eea; }
        
        /* Management actions */
        .management-section { background: #f9fafb; padding: 1.5rem; border-radius: 8px; margin-top: 1rem; }
        .action-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .action-item { background: white; padding: 1rem; border-radius: 6px; border: 1px solid #e5e7eb; }
        .action-title { font-weight: 500; margin-bottom: 0.5rem; }
        .action-desc { font-size: 0.875rem; color: #6b7280; margin-bottom: 1rem; }
        
        /* Status indicators */
        .status-indicator { display: inline-flex; align-items: center; gap: 0.5rem; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; }
        .status-dot.assigned { background: #10b981; }
        .status-dot.unassigned { background: #f59e0b; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function DeviceManagement() {
            const [devices, setDevices] = useState([]);
            const [filteredDevices, setFilteredDevices] = useState([]);
            const [loading, setLoading] = useState(true);
            const [customerInfo, setCustomerInfo] = useState(null);
            const [selectedDevice, setSelectedDevice] = useState(null);
            const [showModal, setShowModal] = useState(false);
            const [mdmServers, setMdmServers] = useState([]);
            const [filters, setFilters] = useState({
                status: 'all',
                model: 'all',
                search: '',
                purchaseSource: 'all',
                color: 'all'
            });
            const [advancedFilters, setAdvancedFilters] = useState({
                showAdvanced: false
            });

            const customerId = new URLSearchParams(window.location.search).get('customer');

            useEffect(() => {
                if (customerId) {
                    fetchDevices();
                    fetchCustomerInfo();
                    fetchMdmServers();
                }
            }, [customerId]);

            useEffect(() => {
                applyFilters();
            }, [devices, filters]);

            const fetchCustomerInfo = async () => {
                try {
                    const response = await fetch(`/api/customers/${customerId}`);
                    const data = await response.json();
                    setCustomerInfo(data);
                } catch (error) {
                    console.error('Error fetching customer info:', error);
                }
            };

            const fetchDevices = async () => {
                try {
                    setLoading(true);
                    const response = await fetch(`/api/${customerId}/devices`);
                    const data = await response.json();
                    setDevices(data.data || []);
                } catch (error) {
                    console.error('Error fetching devices:', error);
                } finally {
                    setLoading(false);
                }
            };

            const fetchMdmServers = async () => {
                try {
                    const response = await fetch(`/api/${customerId}/mdmServers`);
                    const data = await response.json();
                    setMdmServers(data.data || []);
                } catch (error) {
                    console.error('Error fetching MDM servers:', error);
                }
            };

            const applyFilters = () => {
                let filtered = devices;

                if (filters.status !== 'all') {
                    filtered = filtered.filter(device => 
                        device.attributes?.status?.toLowerCase() === filters.status.toLowerCase()
                    );
                }

                if (filters.model !== 'all') {
                    filtered = filtered.filter(device => 
                        device.attributes?.model?.includes(filters.model)
                    );
                }

                if (filters.purchaseSource !== 'all') {
                    filtered = filtered.filter(device => 
                        device.attributes?.purchaseSourceType === filters.purchaseSource
                    );
                }

                if (filters.color !== 'all') {
                    filtered = filtered.filter(device => 
                        device.attributes?.color?.toLowerCase() === filters.color.toLowerCase()
                    );
                }

                if (filters.search) {
                    filtered = filtered.filter(device => 
                        device.attributes?.serialNumber?.toLowerCase().includes(filters.search.toLowerCase()) ||
                        device.attributes?.model?.toLowerCase().includes(filters.search.toLowerCase()) ||
                        device.id?.toLowerCase().includes(filters.search.toLowerCase())
                    );
                }

                setFilteredDevices(filtered);
            };

            const getStats = () => {
                const assigned = devices.filter(d => d.attributes?.status === 'ASSIGNED').length;
                const unassigned = devices.filter(d => d.attributes?.status === 'UNASSIGNED').length;
                const manual = devices.filter(d => d.attributes?.purchaseSourceType === 'MANUALLY_ADDED').length;
                const reseller = devices.filter(d => d.attributes?.purchaseSourceType === 'RESELLER').length;

                return { assigned, unassigned, manual, reseller, total: devices.length };
            };

            const getUniqueValues = (field) => {
                const values = new Set();
                devices.forEach(device => {
                    const value = device.attributes?.[field];
                    if (value) {
                        values.add(value);
                    }
                });
                return Array.from(values).sort();
            };

            const handleFilterChange = (filterType, value) => {
                setFilters(prev => ({
                    ...prev,
                    [filterType]: value
                }));
            };

            const viewDeviceDetails = async (deviceId) => {
                try {
                    const response = await fetch(`/api/${customerId}/devices/${deviceId}`);
                    const device = await response.json();
                    setSelectedDevice(device);
                    setShowModal(true);
                } catch (error) {
                    alert('Error fetching device details');
                }
            };

            const assignDeviceToMDM = async (deviceId, mdmServerId) => {
                try {
                    const payload = {
                        data: {
                            type: "orgDeviceActivities",
                            attributes: {
                                activityType: "ASSIGN_DEVICES"
                            },
                            relationships: {
                                mdmServer: {
                                    data: {
                                        type: "mdmServers",
                                        id: mdmServerId
                                    }
                                },
                                devices: {
                                    data: [{
                                        type: "orgDevices",
                                        id: deviceId
                                    }]
                                }
                            }
                        }
                    };

                    const response = await fetch(`/api/${customerId}/orgDeviceActivities`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        alert('Device assigned successfully!');
                        fetchDevices(); // Refresh device list
                        setShowModal(false);
                    } else {
                        alert('Error assigning device');
                    }
                } catch (error) {
                    alert('Error assigning device: ' + error.message);
                }
            };

            const quickFilter = (filterType) => {
                const newFilters = { ...filters };
                
                switch(filterType) {
                    case 'unassigned':
                        newFilters.status = 'unassigned';
                        break;
                    case 'assigned':
                        newFilters.status = 'assigned';
                        break;
                    case 'manual':
                        newFilters.purchaseSource = 'MANUALLY_ADDED';
                        break;
                    case 'reseller':
                        newFilters.purchaseSource = 'RESELLER';
                        break;
                    case 'reset':
                        newFilters.status = 'all';
                        newFilters.model = 'all';
                        newFilters.purchaseSource = 'all';
                        newFilters.color = 'all';
                        newFilters.search = '';
                        break;
                }
                
                setFilters(newFilters);
            };

            if (!customerId) {
                return (
                    <div className="container">
                        <div className="header">
                            <h1>Error: No customer specified</h1>
                            <p>Please provide a customer ID in the URL parameters.</p>
                        </div>
                    </div>
                );
            }

            if (loading) {
                return (
                    <div className="container">
                        <div className="loading">
                            <div className="spinner"></div>
                            <p>Loading devices...</p>
                        </div>
                    </div>
                );
            }

            const stats = getStats();
            const uniqueModels = getUniqueValues('model');
            const uniqueColors = getUniqueValues('color');

            return (
                <div className="container">
                    <div className="header">
                        <h1>Device Management</h1>
                        <p>
                            {customerInfo ? `${customerInfo.name} - ${customerInfo.manager_type === 'business' ? 'Apple Business Manager' : 'Apple School Manager'}` : 'Loading customer info...'}
                        </p>
                        <p>Total Devices: {stats.total}</p>
                    </div>

                    <div className="stats-grid">
                        <div className="stat-card assigned" onClick={() => quickFilter('assigned')} style={{cursor: 'pointer'}}>
                            <div className="stat-number" style={{color: '#10b981'}}>{stats.assigned}</div>
                            <div className="stat-label">Assigned Devices</div>
                        </div>
                        <div className="stat-card unassigned" onClick={() => quickFilter('unassigned')} style={{cursor: 'pointer'}}>
                            <div className="stat-number" style={{color: '#f59e0b'}}>{stats.unassigned}</div>
                            <div className="stat-label">Unassigned Devices</div>
                        </div>
                        <div className="stat-card manual" onClick={() => quickFilter('manual')} style={{cursor: 'pointer'}}>
                            <div className="stat-number" style={{color: '#8b5cf6'}}>{stats.manual}</div>
                            <div className="stat-label">Manually Added</div>
                        </div>
                        <div className="stat-card reseller" onClick={() => quickFilter('reseller')} style={{cursor: 'pointer'}}>
                            <div className="stat-number" style={{color: '#ef4444'}}>{stats.reseller}</div>
                            <div className="stat-label">From Reseller</div>
                        </div>
                    </div>

                    <div className="filters">
                        <div className="filter-row">
                            <button className="btn btn-filter" onClick={() => quickFilter('reset')}>Show All</button>
                            <button className={`btn btn-filter ${filters.status === 'unassigned' ? 'active' : ''}`} 
                                    onClick={() => quickFilter('unassigned')}>Unassigned Only</button>
                            <button className={`btn btn-filter ${filters.status === 'assigned' ? 'active' : ''}`} 
                                    onClick={() => quickFilter('assigned')}>Assigned Only</button>
                            <button className="btn btn-filter" 
                                    onClick={() => setAdvancedFilters(prev => ({...prev, showAdvanced: !prev.showAdvanced}))}>
                                {advancedFilters.showAdvanced ? 'Hide' : 'Show'} Advanced Filters
                            </button>
                        </div>

                        <div className="filter-grid">
                            <div className="filter-group">
                                <label>Search</label>
                                <input 
                                    type="text" 
                                    placeholder="Serial, model, or device ID..."
                                    value={filters.search}
                                    onChange={(e) => handleFilterChange('search', e.target.value)}
                                />
                            </div>
                            <div className="filter-group">
                                <label>Status</label>
                                <select 
                                    value={filters.status} 
                                    onChange={(e) => handleFilterChange('status', e.target.value)}
                                >
                                    <option value="all">All Status</option>
                                    <option value="assigned">Assigned</option>
                                    <option value="unassigned">Unassigned</option>
                                </select>
                            </div>
                        </div>

                        {advancedFilters.showAdvanced && (
                            <div className="advanced-filters">
                                <div className="filter-grid">
                                    <div className="filter-group">
                                        <label>Model</label>
                                        <select 
                                            value={filters.model} 
                                            onChange={(e) => handleFilterChange('model', e.target.value)}
                                        >
                                            <option value="all">All Models</option>
                                            {uniqueModels.map(model => (
                                                <option key={model} value={model}>{model}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div className="filter-group">
                                        <label>Purchase Source</label>
                                        <select 
                                            value={filters.purchaseSource} 
                                            onChange={(e) => handleFilterChange('purchaseSource', e.target.value)}
                                        >
                                            <option value="all">All Sources</option>
                                            <option value="MANUALLY_ADDED">Manually Added</option>
                                            <option value="RESELLER">Reseller</option>
                                        </select>
                                    </div>
                                    <div className="filter-group">
                                        <label>Color</label>
                                        <select 
                                            value={filters.color} 
                                            onChange={(e) => handleFilterChange('color', e.target.value)}
                                        >
                                            <option value="all">All Colors</option>
                                            {uniqueColors.map(color => (
                                                <option key={color} value={color}>{color}</option>
                                            ))}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>

                    <div className="devices-grid">
                        {filteredDevices.map(device => (
                            <div key={device.id} className="device-card">
                                <div className="device-header">
                                    <div className="device-model">
                                        {device.attributes?.model || 'Unknown Model'}
                                    </div>
                                    <div className="status-indicator">
                                        <div className={`status-dot ${device.attributes?.status?.toLowerCase()}`}></div>
                                        <span className={`status-badge status-${device.attributes?.status?.toLowerCase()}`}>
                                            {device.attributes?.status || 'Unknown'}
                                        </span>
                                    </div>
                                </div>
                                
                                <div className="device-info">
                                    <div className="info-item">
                                        <div className="info-label">Serial Number</div>
                                        <div className="info-value">{device.attributes?.serialNumber || 'N/A'}</div>
                                    </div>
                                    <div className="info-item">
                                        <div className="info-label">Device ID</div>
                                        <div className="info-value">{device.id.substring(0, 12)}...</div>
                                    </div>
                                    <div className="info-item">
                                        <div className="info-label">Purchase Source</div>
                                        <div className="info-value">{device.attributes?.purchaseSourceType || 'N/A'}</div>
                                    </div>
                                    <div className="info-item">
                                        <div className="info-label">Color</div>
                                        <div className="info-value">{device.attributes?.color || 'N/A'}</div>
                                    </div>
                                </div>

                                <div className="device-actions">
                                    <button 
                                        className="btn btn-primary"
                                        onClick={() => viewDeviceDetails(device.id)}
                                    >
                                        View Details
                                    </button>
                                    {device.attributes?.status === 'UNASSIGNED' && (
                                        <button 
                                            className="btn btn-secondary"
                                            onClick={() => {
                                                setSelectedDevice(device);
                                                setShowModal(true);
                                            }}
                                        >
                                            Assign Device
                                        </button>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>

                    {filteredDevices.length === 0 && (
                        <div style={{textAlign: 'center', padding: '3rem', color: '#6b7280'}}>
                            <p>No devices found matching your filters.</p>
                            <button className="btn btn-secondary" onClick={() => quickFilter('reset')} style={{marginTop: '1rem'}}>
                                Clear All Filters
                            </button>
                        </div>
                    )}

                    {/* Device Details/Management Modal */}
                    {showModal && selectedDevice && (
                        <div className="modal-overlay" onClick={() => setShowModal(false)}>
                            <div className="modal" onClick={(e) => e.stopPropagation()}>
                                <div className="modal-header">
                                    <h2 className="modal-title">
                                        {selectedDevice.data ? 'Device Details' : 'Device Management'}
                                    </h2>
                                </div>
                                <div className="modal-body">
                                    {selectedDevice.data ? (
                                        // Detailed view
                                        <div className="detail-grid">
                                            <div className="detail-item">
                                                <div className="detail-label">Device ID</div>
                                                <div className="detail-value">{selectedDevice.data.id}</div>
                                            </div>
                                            <div className="detail-item">
                                                <div className="detail-label">Model</div>
                                                <div className="detail-value">{selectedDevice.data.attributes?.model || 'N/A'}</div>
                                            </div>
                                            <div className="detail-item">
                                                <div className="detail-label">Serial Number</div>
                                                <div className="detail-value">{selectedDevice.data.attributes?.serialNumber || 'N/A'}</div>
                                            </div>
                                            <div className="detail-item">
                                                <div className="detail-label">Status</div>
                                                <div className="detail-value">
                                                    <div className="status-indicator">
                                                        <div className={`status-dot ${selectedDevice.data.attributes?.status?.toLowerCase()}`}></div>
                                                        {selectedDevice.data.attributes?.status || 'Unknown'}
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="detail-item">
                                                <div className="detail-label">Color</div>
                                                <div className="detail-value">{selectedDevice.data.attributes?.color || 'N/A'}</div>
                                            </div>
                                            <div className="detail-item">
                                                <div className="detail-label">Purchase Source</div>
                                                <div className="detail-value">{selectedDevice.data.attributes?.purchaseSourceType || 'N/A'}</div>
                                            </div>
                                        </div>
                                    ) : (
                                        // Management view for unassigned devices
                                        <div>
                                            <div className="detail-grid">
                                                <div className="detail-item">
                                                    <div className="detail-label">Device</div>
                                                    <div className="detail-value">{selectedDevice.attributes?.model || 'Unknown Model'}</div>
                                                </div>
                                                <div className="detail-item">
                                                    <div className="detail-label">Serial Number</div>
                                                    <div className="detail-value">{selectedDevice.attributes?.serialNumber || 'N/A'}</div>
                                                </div>
                                            </div>
                                            
                                            <div className="management-section">
                                                <h3>Assign to MDM Server</h3>
                                                <div className="action-grid">
                                                    {mdmServers.map(server => (
                                                        <div key={server.id} className="action-item">
                                                            <div className="action-title">{server.serverName || server.attributes?.name || server.id}</div>
                                                            <div className="action-desc">
                                                                {server.attributes?.serverName || server.attributes?.name || 'MDM Server'}
                                                            </div>
                                                            <button 
                                                                className="btn btn-primary"
                                                                onClick={() => assignDeviceToMDM(selectedDevice.id, server.id)}
                                                            >
                                                                Assign Here
                                                            </button>
                                                        </div>
                                                    ))}
                                                </div>
                                                {mdmServers.length === 0 && (
                                                    <p style={{color: '#6b7280', textAlign: 'center'}}>
                                                        No MDM servers available for assignment.
                                                    </p>
                                                )}
                                            </div>
                                        </div>
                                    )}
                                </div>
                                <div className="modal-footer">
                                    <button className="btn btn-secondary" onClick={() => setShowModal(false)}>
                                        Close
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<DeviceManagement />, document.getElementById('root'));
    </script>
</body>
</html>
