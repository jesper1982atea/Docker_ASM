<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GSX Device Details</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/frontend/css/atea-style.css">
</head>
<body>
    <div id="root"></div>
    <script type="text/babel" src="/frontend/js/gsx-device-details.js"></script>
</body>
</html>
            --atea-black: #000000;
            --border-color: #e0e0e0;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--atea-light-grey); color: var(--atea-grey); }
        .container { max-width: 900px; margin: 2rem auto; padding: 2rem; background: var(--atea-white); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .header { border-bottom: 1px solid var(--border-color); padding-bottom: 1.5rem; margin-bottom: 1.5rem; }
        .header h1 { font-size: 2rem; color: var(--atea-black); font-weight: 700; }
        .header p { color: var(--atea-grey); }
        .header-links { margin-top: 1rem; display: flex; gap: 1rem; flex-wrap: wrap; }
        .header-link { background: var(--atea-light-grey); color: var(--atea-green); padding: 0.5rem 1rem; border-radius: 5px; text-decoration: none; font-size: 0.875rem; font-weight: 600; transition: background 0.2s; border: none; cursor: pointer; }
        .header-link:hover { background-color: var(--atea-green-light); color: var(--atea-white); }
        .loading { text-align: center; padding: 4rem; }
        .spinner { border: 4px solid var(--atea-light-grey); border-top: 4px solid var(--atea-green); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .section { background: var(--atea-light-grey); padding: 1.5rem; border-radius: 8px; margin-top: 2rem; }
        .section h3 { margin-bottom: 1rem; color: var(--atea-black); border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; font-weight: 600; }
        .detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; }
        .detail-item { background: var(--atea-white); padding: 1rem; border-radius: 5px; border: 1px solid var(--border-color); }
        .detail-label { font-size: 0.875rem; color: var(--atea-grey); margin-bottom: 0.25rem; display: block; }
        .detail-value { font-weight: 600; color: var(--atea-black); word-break: break-all; }
        .message-list { list-style: none; padding: 0; }
        .message-item { background: var(--atea-white); padding: 1rem; border-radius: 5px; border: 1px solid var(--border-color); margin-bottom: 0.5rem; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        function GsxDeviceDetailsPage() {
            const [gsxDetails, setGsxDetails] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            const params = new URLSearchParams(window.location.search);
            const customerId = params.get('customer');
            const serial = params.get('serial');
            const pageRef = useRef(null);

            useEffect(() => {
                if (!customerId || !serial) {
                    setError("Customer ID or Serial Number is missing from URL.");
                    setLoading(false);
                    return;
                }
                
                const fetchDetails = async () => {
                    try {
                        setLoading(true);
                        const res = await fetch(`/api/${customerId}/gsx/device-details/${serial}`);
                        if (!res.ok) throw new Error(`Failed to fetch GSX details: ${res.statusText}`);
                        const data = await res.json();
                        if (data && data.device) {
                            setGsxDetails(data.device);
                        } else {
                            throw new Error("Device not found in GSX response.");
                        }
                    } catch (err) {
                        setError(err.message);
                    } finally {
                        setLoading(false);
                    }
                };

                fetchDetails();
            }, [customerId, serial]);

            const handleExportExcel = () => {
                if (!gsxDetails) return;

                const data = [
                    { Category: 'General Information', Key: 'Product Description', Value: gsxDetails.productDescription },
                    { Category: 'General Information', Key: 'Configuration', Value: gsxDetails.configDescription },
                    { Category: 'General Information', Key: 'Sold To', Value: gsxDetails.soldToName },
                    { Category: 'General Information', Key: 'Purchase Country', Value: `${gsxDetails.warrantyInfo?.purchaseCountryDesc} (${gsxDetails.warrantyInfo?.purchaseCountryCode})` },
                    { Category: 'General Information', Key: 'Loaner Device', Value: gsxDetails.loaner ? 'Yes' : 'No' },
                    
                    { Category: 'Warranty Details', Key: 'Status', Value: gsxDetails.warrantyInfo?.warrantyStatusDescription },
                    { Category: 'Warranty Details', Key: 'Purchase Date', Value: new Date(gsxDetails.warrantyInfo?.purchaseDate).toLocaleDateString() },
                    { Category: 'Warranty Details', Key: 'Registration Date', Value: new Date(gsxDetails.warrantyInfo?.registrationDate).toLocaleDateString() },
                    { Category: 'Warranty Details', Key: 'Days Remaining', Value: gsxDetails.warrantyInfo?.daysRemaining },
                    
                    { Category: 'Activation & Carrier', Key: 'First Activation', Value: gsxDetails.activationDetails?.firstActivationDate ? new Date(gsxDetails.activationDetails.firstActivationDate).toLocaleString() : 'N/A' },
                    { Category: 'Activation & Carrier', Key: 'Unlocked', Value: gsxDetails.activationDetails?.unlocked ? 'Yes' : 'No' },
                    { Category: 'Activation & Carrier', Key: 'Carrier', Value: gsxDetails.activationDetails?.carrierName || 'N/A' },

                    { Category: 'Product Information', Key: 'Serial Number', Value: gsxDetails.identifiers?.serial || serial },
                    { Category: 'Product Information', Key: 'IMEI', Value: gsxDetails.identifiers?.imei || 'N/A' },
                    { Category: 'Product Information', Key: 'IMEI 2', Value: gsxDetails.identifiers?.imei2 || 'N/A' },
                ];

                (gsxDetails.caseDetails || []).forEach((c, i) => {
                    data.push({ Category: 'Repair Cases', Key: `Case ${i+1} ID`, Value: c.caseId });
                    data.push({ Category: 'Repair Cases', Key: `Case ${i+1} Summary`, Value: c.summary });
                    data.push({ Category: 'Repair Cases', Key: `Case ${i+1} Created`, Value: new Date(c.createdDateTime).toLocaleString() });
                });

                const worksheet = XLSX.utils.json_to_sheet(data);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Device Details");
                worksheet["!cols"] = [{wch:25}, {wch:25}, {wch:40}];
                XLSX.writeFile(workbook, `GSX_Details_${serial}.xlsx`);
            };

            const handleExportPdf = () => {
                if (!pageRef.current) return;
                
                html2canvas(pageRef.current, { scale: 2 }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jspdf.jsPDF({
                        orientation: 'p',
                        unit: 'mm',
                        format: 'a4'
                    });
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    const canvasWidth = canvas.width;
                    const canvasHeight = canvas.height;
                    const ratio = canvasWidth / canvasHeight;
                    const height = pdfWidth / ratio;

                    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, height);
                    pdf.save(`GSX_Details_${serial}.pdf`);
                });
            };

            if (loading) {
                return <div className="loading"><div className="spinner"></div><p>Loading GSX device details...</p></div>;
            }

            if (error) {
                return <div className="container"><h1>Error</h1><p>{error}</p></div>;
            }

            if (!gsxDetails) {
                return <div className="container"><h1>Error</h1><p>Could not load device details.</p></div>;
            }

            const { productDescription, warrantyInfo, soldToName, productImageURL, activationDetails, identifiers, caseDetails, configDescription, configCode, loaner, consumerLawInfo, messages, productLine } = gsxDetails;

            return (
                <div className="container" ref={pageRef}>
                    <div className="header">
                        <div style={{display: 'flex', alignItems: 'center', gap: '1rem'}}>
                            {productImageURL && <img src={productImageURL} alt="Product" style={{height: '60px', borderRadius: '8px'}} />}
                            <div>
                                <h1>{productDescription}</h1>
                                <p>Serial Number: {serial}</p>
                            </div>
                        </div>
                        <div className="header-links">
                            <a href={`/frontend/gsx-search.html?customer=${customerId}`} className="header-link">
                                ⬅️ Back to GSX Search
                            </a>
                            <a href={`/frontend/customer-devices.html?customer=${customerId}`} className="header-link">
                                📦 Device List
                            </a>
                             <a href="/frontend/" className="header-link">
                                🏠 Admin Panel
                            </a>
                            <button onClick={handleExportExcel} className="header-link">Export to Excel</button>
                            <button onClick={handleExportPdf} className="header-link">Export to PDF</button>
                        </div>
                    </div>

                    <div className="section">
                        <h3>General Information</h3>
                        <div className="detail-grid">
                            <div className="detail-item"><div className="detail-label">Configuration</div><div className="detail-value">{configDescription}</div></div>
                            <div className="detail-item"><div className="detail-label">Sold To</div><div className="detail-value">{soldToName}</div></div>
                            <div className="detail-item"><div className="detail-label">Purchase Country</div><div className="detail-value">{warrantyInfo?.purchaseCountryDesc} ({warrantyInfo?.purchaseCountryCode})</div></div>
                            <div className="detail-item"><div className="detail-label">Loaner Device</div><div className="detail-value">{loaner ? 'Yes' : 'No'}</div></div>
                        </div>
                    </div>

                    <div className="section">
                        <h3>Warranty Details</h3>
                        <div className="detail-grid">
                             <div className="detail-item"><div className="detail-label">Status</div><div className="detail-value" style={{ color: warrantyInfo?.warrantyStatusCode !== 'OO' ? 'green' : 'red' }}>{warrantyInfo?.warrantyStatusDescription}</div></div>
                            <div className="detail-item"><div className="detail-label">Purchase Date</div><div className="detail-value">{new Date(warrantyInfo?.purchaseDate).toLocaleDateString()}</div></div>
                            <div className="detail-item"><div className="detail-label">Registration Date</div><div className="detail-value">{new Date(warrantyInfo?.registrationDate).toLocaleDateString()}</div></div>
                            <div className="detail-item"><div className="detail-label">Days Remaining</div><div className="detail-value">{warrantyInfo?.daysRemaining}</div></div>
                            <div className="detail-item"><div className="detail-label">Labor Covered</div><div className="detail-value">{warrantyInfo?.laborCovered ? 'Yes' : 'No'}</div></div>
                            <div className="detail-item"><div className="detail-label">Part Covered</div><div className="detail-value">{warrantyInfo?.partCovered ? 'Yes' : 'No'}</div></div>
                            <div className="detail-item"><div className="detail-label">Onsite Coverage</div><div className="detail-value">{warrantyInfo?.onsiteCoverage ? 'Yes' : 'No'}</div></div>
                        </div>
                        {warrantyInfo?.deviceCoverageDetails && (
                            <div style={{marginTop: '1rem'}}>
                                <h4>Coverage Details</h4>
                                <ul className="message-list">
                                    {warrantyInfo.deviceCoverageDetails.map((msg, i) => <li key={i} className="message-item">{msg}</li>)}
                                </ul>
                            </div>
                        )}
                    </div>

                    {activationDetails && <div className="section">
                        <h3>Activation & Carrier</h3>
                        <div className="detail-grid">
                            <div className="detail-item"><div className="detail-label">First Activation</div><div className="detail-value">{activationDetails.firstActivationDate ? new Date(activationDetails.firstActivationDate).toLocaleString() : 'N/A'}</div></div>
                            <div className="detail-item"><div className="detail-label">Unlocked</div><div className="detail-value" style={{ color: activationDetails.unlocked ? 'green' : 'orange' }}>{activationDetails.unlocked ? 'Yes' : 'No'}</div></div>
                            <div className="detail-item"><div className="detail-label">Carrier</div><div className="detail-value">{activationDetails.carrierName || 'N/A'}</div></div>
                            <div className="detail-item"><div className="detail-label">Last Restore</div><div className="detail-value">{activationDetails.lastRestoreDate ? new Date(activationDetails.lastRestoreDate).toLocaleString() : 'N/A'}</div></div>
                            <div className="detail-item"><div className="detail-label">Unlock Date</div><div className="detail-value">{activationDetails.unlockDate ? new Date(activationDetails.unlockDate).toLocaleString() : 'N/A'}</div></div>
                            <div className="detail-item"><div className="detail-label">OS Version</div><div className="detail-value">{activationDetails.productVersion}</div></div>
                            <div className="detail-item"><div className="detail-label">Last Unbrick OS</div><div className="detail-value">{activationDetails.lastUnbrickOsBuild}</div></div>
                        </div>
                    </div>}
                    
                    {activationDetails && <div className="section">
                        <h3>Activation Policy</h3>
                        <div className="detail-grid">
                            <div className="detail-item"><div className="detail-label">Initial Policy</div><div className="detail-value">{activationDetails.initialActivationPolicyDetails} ({activationDetails.initialActivationPolicyID})</div></div>
                            <div className="detail-item"><div className="detail-label">Applied Policy</div><div className="detail-value">{activationDetails.appliedActivationDetails} ({activationDetails.appliedActivationPolicyID})</div></div>
                            <div className="detail-item"><div className="detail-label">Next Tether Policy</div><div className="detail-value">{activationDetails.nextTetherPolicyDetails} ({activationDetails.nextTetherPolicyID})</div></div>
                        </div>
                    </div>}

                    {identifiers && <div className="section">
                        <h3>Product Information</h3>
                        <div className="detail-grid">
                            <div className="detail-item"><div className="detail-label">Serial Number</div><div className="detail-value">{identifiers.serial || serial}</div></div>
                            {identifiers.imei && <div className="detail-item"><div className="detail-label">IMEI</div><div className="detail-value">{identifiers.imei}</div></div>}
                            {identifiers.imei2 && <div className="detail-item"><div className="detail-label">IMEI 2</div><div className="detail-value">{identifiers.imei2}</div></div>}
                            <div className="detail-item"><div className="detail-label">Config Code</div><div className="detail-value">{configCode}</div></div>
                            <div className="detail-item"><div className="detail-label">Product Line</div><div className="detail-value">{productLine}</div></div>
                        </div>
                    </div>}
                    
                    {messages && messages.length > 0 && <div className="section">
                        <h3>Messages</h3>
                        <ul className="message-list">
                            {messages.map((msg, i) => (
                                <li key={i} className="message-item">
                                    <div className="detail-label">{msg.type}</div>
                                    <div className="detail-value">{msg.message}</div>
                                </li>
                            ))}
                        </ul>
                    </div>}

                    {caseDetails && caseDetails.length > 0 && <div className="section">
                        <h3>Repair Cases ({caseDetails.length})</h3>
                        <div className="detail-grid">
                            {caseDetails.map(c => (
                                <div key={c.caseId} className="detail-item">
                                    <div className="detail-label">Case {c.caseId} ({new Date(c.createdDateTime).toLocaleDateString()})</div>
                                    <div className="detail-value">{c.summary}</div>
                                </div>
                            ))}
                        </div>
                    </div>}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<GsxDeviceDetailsPage />);
    </script>
</body>
</html>
